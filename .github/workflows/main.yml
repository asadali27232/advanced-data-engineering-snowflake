name: ğŸš€ Deploy Data Pipeline

on:
  push:
    branches:
      - staging
      - main

jobs:
  deploy_data_pipelin
    runs-on: ubuntu-latest

    env:
      # ğŸ” Snowflake connection secrets
      SNOWFLAKE_CONNECTIONS_ADVANCED_DATA_ENGINEERING_SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_ADVANCED_DATA_ENGINEERING_SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_ADVANCED_DATA_ENGINEERING_SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}

    steps:

      # ğŸ“¥ Checkout repository
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ğŸ¯ Determine deployment environment (staging/prod)
      - name: âš™ï¸ Set deployment environment
        id: set_env
        run: |
          echo "ğŸ” Determining target environment..."
          
          TARGET_BRANCH="${GITHUB_REF#refs/heads/}"

          if [[ $TARGET_BRANCH == "staging" ]]; then
            echo "DEPLOY_ENV=STAGING" >> $GITHUB_ENV
            echo "ğŸš§ Environment set to *staging*"
          elif [[ $TARGET_BRANCH == "main" ]]; then
            echo "DEPLOY_ENV=PROD" >> $GITHUB_ENV
            echo "ğŸ Environment set to *production*"
          else
            echo "âŒ Unexpected branch: $TARGET_BRANCH"
            exit 1
          fi

      # ğŸ§° Install Snowflake CLI
      - name: ğŸ§° Install Snowflake CLI
        uses: snowflakedb/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: "config.toml"

      # ğŸ”„ Fetch latest Git changes from Snowflake Git repository
      - name: ğŸ”„ Fetch latest changes from Snowflake Git repo
        run: |
          echo "ğŸ“¡ Fetching updates from Snowflake Git repo..."
          snow git fetch course_repo.public.advanced_data_engineering_snowflake

      # ğŸš€ Deploy templated SQL pipelines into Snowflake
      - name: ğŸš€ Deploy templates to Snowflake
        run: |
          echo "ğŸ“ Using Git branch: ${GITHUB_REF#refs/heads/}"
          echo "ğŸŒ Deploying to env: ${DEPLOY_ENV}"

          echo "ğŸ“¦ Deploying DATA templates..."
          snow git execute @advanced_data_engineering_snowflake/branches/${GITHUB_REF#refs/heads/}/module-1/hamburg_weather/pipeline/data/ \
            -D "env='${DEPLOY_ENV}'" \
            --database=COURSE_REPO \
            --schema=PUBLIC \
            --warehouse=WORKING_WH

          echo "ğŸ— Deploying OBJECT templates..."
          snow git execute @advanced_data_engineering_snowflake/branches/${GITHUB_REF#refs/heads/}/module-1/hamburg_weather/pipeline/objects/ \
            -D "env='${DEPLOY_ENV}'" \
            --database=COURSE_REPO \
            --schema=PUBLIC \
            --warehouse=WORKING_WH

          echo "âœ… Deployment completed successfully!"
